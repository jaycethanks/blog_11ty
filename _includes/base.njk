<!DOCTYPE html>
<html lang="{{ site.language }}">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="" type="image/svg+xml">
        <meta
        name="generator" content="{{ eleventy.generator }}">
        {# 不算子站点统计：https://ibruce.info/2015/04/04/busuanzi/ #}
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        {% if site.description %}
            <meta name="description" content="{{ site.description }}">
        {% endif %}
        <title>{{ title or site.title }}</title>
        <link rel="stylesheet" href="{{ '/css/main.css' | url }}">
        {% if page.url == '/' %}
            <script>
                if (location.hash) 
                    window.location = `/admin/#${
                        location
                            .href
                            .split("#")
                            .pop()
                    }`
            </script>
        {% endif %}
        {# google analysis #}
        <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics_id }}"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag('js', new Date());
            gtag('config', '{{ site.google_analytics_id }}');
        </script>
    </head>
    <body>
        <div id="color-mode" title="change color mode">
            
        </div>
        {{ content | safe }}
        {# <script src="https://cdn.bootcdn.net/ajax/libs/eruda/2.3.3/eruda.min.js"></script>
        <script>eruda.init();</script> #}
        <script>
            const colorModeBtn = document.querySelector('#color-mode')
            const DarkBtnColor = '#fff'
            const LightBtnColor = '#000'
            colorModeBtn.addEventListener('click',()=>{
                const hasDarkClass = document.documentElement.classList.toggle('dark')
                if(hasDarkClass){
                    colorModeBtn.style.backgroundColor = DarkBtnColor
                }else{
                    colorModeBtn.style.backgroundColor = LightBtnColor
                }
                localStorage.setItem('mode', hasDarkClass ? 'dark' : 'light')
                updateFavicon(hasDarkClass)
            })

            function setTheme(isDark){
                if(isDark){
                  document.documentElement.classList.add('dark')
                  colorModeBtn.style.backgroundColor = DarkBtnColor
                }else{
                  document.documentElement.classList.remove('dark')
                  colorModeBtn.style.backgroundColor = LightBtnColor
                }
                updateFavicon(isDark)
            }

            function updateFavicon(isDark){
                const link = document.querySelector("link[rel~='icon']");
                console.log("link:",link)
                
                /**
                * TODO: 显然这里的hard code 路径blog_11ty 是不合理的， 这样在开发模式下必须指定一个prefix 以启动（https://www.11ty.dev/docs/config/#example-7）
                * 有空的时候研究下 11ty 的public path 或者 baseUrl 之类的怎么设定的，这种hard code 在其他地方也用到了，暂时就这样，没空研究
                */
                link.href = isDark ? '/blog_11ty/favicon-dark.svg' : '/blog_11ty/favicon-light.svg';
            }

            function setDefaultThemeColor(){
                // 先看用户有没有历史设定颜色，如果没有，用操作系统默认颜色
                const historySettingMode = localStorage.getItem('mode')
                let isDark = false
                if(historySettingMode){
                    isDark = historySettingMode === 'dark'
                }else{
                    //如果用户没有设置过颜色，那么使用系统默认颜色
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        // dark mode
                        isDark = true
                    }else{
                        isDark = false
                    }
                }
                setTheme(isDark)
            }
            setDefaultThemeColor()


            //监听系统颜色修改
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                const isDark = event.matches;
                setTheme(isDark)
                // 移除用户颜色模式设定
                localStorage.removeItem('mode')
            });
        </script>
    </body>
    <footer id="footer">
        {% include "footer.njk" %}
    </footer>
</html>
